<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì •ì±…ì—°êµ¬ ì§€ì› ì¸í¬ê·¸ë˜í”½ ì‹œìŠ¤í…œ</title>
    
    <!-- Tailwind CSS CDN ë¡œë“œ --><script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
        }
        .container-box {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        /* ì´ë¯¸ì§€ ë†’ì´ë¥¼ ìœ ë™ì ìœ¼ë¡œ ì²˜ë¦¬í•˜ì—¬ ì „ì²´ê°€ ë‹¤ ë³´ì´ê²Œ í•¨ */
        .infographic-box {
            min-height: 400px;
            height: auto;
            transition: all 0.3s ease;
        }
        /* êµ¬ì¡°í™” í…ìŠ¤íŠ¸ ì˜ì—­ ìŠ¤íƒ€ì¼ */
        #structuredDataArea {
            min-height: 400px;
            height: auto; /* ë‚´ìš©ì— ë”°ë¼ ëŠ˜ì–´ë‚˜ë„ë¡ ì„¤ì • */
            overflow-y: auto;
            white-space: pre-wrap; /* ë§ˆí¬ë‹¤ìš´ ê°œì¡°ì‹ ì¤„ë°”ê¿ˆ ë° ë“¤ì—¬ì“°ê¸° ìœ ì§€ */
            border-left: 1px solid #e2e8f0;
            text-align: left; /* ëª…ì‹œì  ì¢Œì¸¡ ì •ë ¬ */
            line-height: 1.6; /* ê°€ë…ì„± í–¥ìƒ */
            /* Markdown ê°œì¡°ì‹ ê°€ë…ì„±ì„ ìœ„í•œ íŒ¨ë”© ì¡°ì • */
            padding-left: 1rem;
            padding-right: 1rem;
        }
        
        /* ê¸°íƒ€ ìŠ¤íƒ€ì¼ */
        .file-upload-label { cursor: pointer; transition: background-color 0.2s; }
        .file-upload-label:hover { background-color: #f3f4f6; }
        #dropZone { border: 2px dashed #9ca3af; background-color: #f9fafb; transition: all 0.2s; }
        #dropZone.drag-over { border-color: #4f46e5; background-color: #eef2ff; }
        #promptButton { display: none; }
        #promptModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background-color: white; padding: 25px; border-radius: 12px; width: 90%; max-width: 600px; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2); }
    </style>
</head>
<body>
    <div class="container-box min-h-screen">
        <!-- ë©‹ì§€ê²Œ ë””ìì¸ëœ í—¤ë” ë°•ìŠ¤ --><header class="text-center py-8 mb-6 rounded-xl shadow-2xl ring-2 ring-indigo-100 bg-gradient-to-r from-blue-50 to-indigo-50">
            <h1 class="text-4xl font-extrabold text-gray-900 mb-1">
                <span class="text-indigo-600">ğŸ›ï¸</span> ì •ì±…ì—°êµ¬ ì§€ì› ì¸í¬ê·¸ë˜í”½ ì‹œìŠ¤í…œ
            </h1>
            <!-- 2. ì œëª© ì•„ë˜ ì„¤ëª… ë¬¸êµ¬ ë³€ê²½ ë°˜ì˜ --><p class="text-gray-600 mt-2 text-lg font-medium border-t border-indigo-200 pt-2 mx-10">ì²¨ë¶€ íŒŒì¼ê³¼ ì„ íƒí•œ ìœ í˜•ì„ ê¸°ë°˜ìœ¼ë¡œ, ë””ìì¸ í…œí”Œë¦¿ê³¼ êµ¬ì¡°í™”ëœ í•œêµ­ì–´ í…ìŠ¤íŠ¸ë¥¼ ì œì•ˆí•©ë‹ˆë‹¤.</p>
        </header>

        <main>
            <!-- 1ë‹¨ê³„: ì…ë ¥ ë° ì œì–´ íŒ¨ë„ --><div class="bg-white p-6 rounded-xl shadow-xl mb-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">1ë‹¨ê³„: ì£¼ì œ, ìœ í˜•, ìƒ‰ìƒ ë° íŒŒì¼ ì²¨ë¶€</h2>
                
                <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
                    <!-- ì¸í¬ê·¸ë˜í”½ ìœ í˜• ì„ íƒ --><div class="col-span-1">
                        <label for="infographicType" class="block text-sm font-medium text-gray-700 mb-1">ì¸í¬ê·¸ë˜í”½ ìœ í˜•:</label>
                        <select id="infographicType" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 bg-white">
                            <option value="PolicyRecommendation" selected>ì •ì±… ì¶”ì²œí˜• (ë¬¸ì œ, í•´ê²°ì±…, ê¸°ëŒ€ íš¨ê³¼)</option>
                            <option value="Statistical">í†µê³„í˜• (ê·¸ë˜í”„, ì°¨íŠ¸, ë°ì´í„°)</option>
                            <option value="Timeline">íƒ€ì„ë¼ì¸ (ì—°ëŒ€ìˆœ ì´ë²¤íŠ¸, ë¡œë“œë§µ)</option>
                            <option value="Process">í”„ë¡œì„¸ìŠ¤ (ë‹¨ê³„ë³„ ë°©ë²•, ì›Œí¬í”Œë¡œ)</option>
                            <option value="Comparison">ë¹„êµí˜• (ì˜µì…˜, ì œí’ˆ, ì •ì±… ë¹„êµ)</option>
                            <option value="Geographical/Map">ì§€ë¦¬/ì§€ë„ (ìœ„ì¹˜ ê¸°ë°˜ ë°ì´í„°)</option>
                            <option value="Sectional Information">ì„¹ì…˜ ê¸°ë°˜ ì •ë³´í˜• (ë¶„í• ëœ ì •ë³´ ë¸”ë¡)</option>
                            <option value="Centralized Hub">ì¤‘ì•™ ì§‘ì¤‘í˜• (ì¤‘ì•™ ì£¼ì œ, ë°©ì‚¬í˜• ì •ë³´)</option>
                        </select>
                    </div>

                    <!-- ìƒ‰ìƒ íŒ”ë ˆíŠ¸ ì„ íƒ ê¸°ëŠ¥ --><div class="col-span-1">
                        <label for="colorPalette" class="block text-sm font-medium text-gray-700 mb-1">ğŸ¨ ìƒ‰ìƒ íŒ”ë ˆíŠ¸ ì„ íƒ:</label>
                        <select id="colorPalette" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 bg-white">
                            <option value="Policy Blue/Gray" selected>ì •ì±…í˜• ë¸”ë£¨/ê·¸ë ˆì´ (ì‹ ë¢°, ì•ˆì •)</option>
                            <option value="Vibrant Red/Yellow/Black">ê²½ê³ í˜• ë ˆë“œ/ì˜ë¡œìš° (ê¸´ê¸‰, ìœ„í—˜ ë¶„ì„)</option>
                            <option value="Nature Green/Earth Tones">í™˜ê²½/ì§€ì†ê°€ëŠ¥í˜• (í™˜ê²½, ESG)</option>
                            <option value="Modern Teal/Orange">ëª¨ë˜ í…Œë§ˆ (í˜ì‹ , ê¸°ìˆ )</option>
                        </select>
                    </div>
                    
                    <!-- ì´ë¯¸ì§€ ë¹„ìœ¨ ì„ íƒ ê¸°ëŠ¥ --><div class="col-span-1">
                        <label for="aspectRatio" class="block text-sm font-medium text-gray-700 mb-1">ğŸ“ ì´ë¯¸ì§€ ë¹„ìœ¨ ì„ íƒ:</label>
                        <select id="aspectRatio" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 bg-white">
                            <option value="16:9" selected>16:9 (ê°€ë¡œ í‘œì¤€ / ë³´ê³ ì„œ)</option>
                            <option value="4:3">4:3 (í”„ë ˆì  í…Œì´ì…˜)</option>
                            <option value="1:1">1:1 (ì •ì‚¬ê°í˜• / SNS)</option>
                            <option value="9:16">9:16 (ì„¸ë¡œí˜• / ìŠ¤í† ë¦¬)</option>
                        </select>
                    </div>
                </div>

                <!-- í…ìŠ¤íŠ¸ ì…ë ¥ --><textarea id="topicInput" rows="3" class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 resize-none text-base" placeholder="ì¸í¬ê·¸ë˜í”½ì˜ í•µì‹¬ ì£¼ì œë‚˜, ì²¨ë¶€ íŒŒì¼ì— ëŒ€í•œ ê°„ë‹¨í•œ ì„¤ëª…ì„ í•œêµ­ì–´ë¡œ ì…ë ¥í•˜ì„¸ìš”."></textarea>

                <!-- ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì˜ì—­ ë° ë‹¤ì¤‘ íŒŒì¼ ì²¨ë¶€ --><div id="dropZone" class="p-4 mb-4 rounded-lg flex flex-col items-center justify-center text-center">
                    <p class="text-gray-700 font-medium mb-2">ì—¬ê¸°ì— íŒŒì¼ì„ ëŒì–´ë‹¤ ë†“ìœ¼ì„¸ìš”.</p>
                    <p class="text-sm text-gray-500 mb-3">ë˜ëŠ” ì•„ë˜ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”. (ìµœëŒ€ 5ê°œ íŒŒì¼)</p>
                    
                    <input type="file" id="fileInput" class="hidden" multiple accept=".pdf,.doc,.docx,.txt,.md,.rtf,.odt,.xls,.xlsx,.csv,.ods,.json,.tsv,.png,.jpg,.jpeg,.gif,.webp,.ppt,.pptx,.odp,.html,.htm,.xml,.tex,.zip">
                    <label for="fileInput" class="file-upload-label w-1/2 flex items-center justify-center px-4 py-2 border border-indigo-400 text-indigo-600 bg-white rounded-lg shadow-sm font-medium hover:border-indigo-600">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                        íŒŒì¼ ì„ íƒ (ì—¬ëŸ¬ ê°œ ê°€ëŠ¥)
                    </label>
                    <div id="fileNameDisplay" class="text-sm text-gray-500 text-center mt-3 w-full max-h-24 overflow-y-auto">ì²¨ë¶€ëœ íŒŒì¼ ì—†ìŒ</div>
                </div>
                
                <div class="flex space-x-4">
                    <!-- ë¦¬ì…‹ ë²„íŠ¼ --><button id="resetButton" onclick="resetForm()" class="w-1/4 bg-gray-400 text-white py-3 rounded-xl font-bold text-lg hover:bg-gray-500 transition duration-150 shadow-md flex items-center justify-center">
                        ì´ˆê¸°í™”
                    </button>
                    <!-- í”„ë¡¬í”„íŠ¸ ë³´ê¸° ë²„íŠ¼ (ë””ë²„ê¹…ìš©) --><button id="promptButton" onclick="showPromptModal()" class="w-1/4 bg-purple-600 text-white py-3 rounded-xl font-bold text-lg hover:bg-purple-700 transition duration-150 shadow-md flex items-center justify-center">
                        í”„ë¡¬í”„íŠ¸ ë³´ê¸°
                    </button>
                    <button id="generateButton" onclick="generateInfographics()" class="w-2/4 bg-indigo-600 text-white py-3 rounded-xl font-bold text-lg hover:bg-indigo-700 transition duration-150 shadow-md flex items-center justify-center">
                        <span id="buttonText">ì¸í¬ê·¸ë˜í”½ ì‹œì•ˆ ìƒì„± ì‹œì‘</span>
                        <svg id="loadingSpinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- 2ë‹¨ê³„: ê²°ê³¼ ì¶œë ¥ íŒ¨ë„ --><div class="bg-white p-6 rounded-xl shadow-xl">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">2ë‹¨ê³„: ìƒì„±ëœ ê²°ê³¼ë¬¼ (PPT ìµœì í™”)</h2>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- ë””ìì¸ í…œí”Œë¦¿ (ì´ë¯¸ì§€) --><div class="col-span-1">
                        <h3 class="font-bold text-gray-700 mb-2">ë””ìì¸ í…œí”Œë¦¿ (PNG ì´ë¯¸ì§€)</h3>
                        <div id="infographicContainer" class="infographic-box w-full flex items-center justify-center bg-gray-100 rounded-lg border-2 border-dashed border-gray-300 overflow-hidden relative">
                            <p class="text-gray-500 text-center p-4" id="messageA">ì£¼ì œë¥¼ ì…ë ¥í•˜ê³  ìƒì„± ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</p>
                            <img id="imageA" src="" alt="ìƒì„±ëœ ì¸í¬ê·¸ë˜í”½ ë””ìì¸ í…œí”Œë¦¿" class="max-w-full h-auto object-contain hidden">
                        </div>
                        <button id="downloadButton" class="mt-4 w-full bg-green-600 text-white py-2 px-4 rounded-xl font-bold hover:bg-green-700 transition duration-150 shadow-md">
                            í…œí”Œë¦¿ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ (.png)
                        </button>
                    </div>

                    <!-- êµ¬ì¡°í™”ëœ í•œêµ­ì–´ í…ìŠ¤íŠ¸ --><div class="col-span-1">
                        <div class="flex justify-between items-center mb-2 pt-1 md:pt-0">
                            <h3 class="font-bold text-gray-700">êµ¬ì¡°í™”ëœ í•œêµ­ì–´ í…ìŠ¤íŠ¸ (PPT ì‚½ì… ìµœì í™”)</h3>
                            <button id="copyButton" class="text-xs text-indigo-600 hover:text-indigo-800 font-semibold py-1 px-2 border border-indigo-200 rounded-lg transition duration-150">í…ìŠ¤íŠ¸ ë³µì‚¬</button>
                        </div>
                        <!-- 1. êµ¬ì¡°í™”ëœ í…ìŠ¤íŠ¸ ì¢Œì¸¡ ì •ë ¬ ë° ë†’ì´ ì¡°ì • --><textarea id="structuredDataArea" class="w-full p-3 border border-gray-300 rounded-lg bg-gray-50 text-sm focus:ring-indigo-500 text-left" style="min-height: 400px; height: auto;" readonly placeholder="ì—¬ê¸°ì— Geminiê°€ ë¶„ì„í•œ ì •í™•í•œ í•œêµ­ì–´ í…ìŠ¤íŠ¸ ì •ë³´ê°€ êµ¬ì¡°í™”ë˜ì–´ ë‚˜íƒ€ë‚©ë‹ˆë‹¤."></textarea>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- í”„ë¡¬í”„íŠ¸ ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ UI --><div id="promptModal" class="flex">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-4 text-gray-800">ğŸ–¼ï¸ Gemini ì´ë¯¸ì§€ ìƒì„± í”„ë¡¬í”„íŠ¸</h3>
            <p class="text-sm text-gray-600 mb-3">ì´ í”„ë¡¬í”„íŠ¸ëŠ” Gemini ëª¨ë¸ì´ ì¸í¬ê·¸ë˜í”½ ìœ í˜•, ìƒ‰ìƒ, ì²¨ë¶€ íŒŒì¼ì„ ë¶„ì„í•˜ì—¬ Imagen ëª¨ë¸ì—ê²Œ ì „ë‹¬í•œ ìµœì¢… ì§€ì‹œì–´ì…ë‹ˆë‹¤.</p>
            <textarea id="promptDisplayArea" rows="10" class="w-full p-3 border border-gray-300 rounded-lg resize-none text-xs bg-gray-50" readonly></textarea>
            <button onclick="closePromptModal()" class="mt-4 w-full bg-indigo-600 text-white py-2 rounded-xl font-bold hover:bg-indigo-700">ë‹«ê¸°</button>
        </div>
    </div>


    <script type="module">
        // API í‚¤ëŠ” Canvas í™˜ê²½ì—ì„œ ìë™ìœ¼ë¡œ ì œê³µë©ë‹ˆë‹¤.
        const apiKey = ""; 
        
        // ëª¨ë¸ ì •ë³´
        const GEMINI_API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent";
        const IMAGEN_API_URL = "https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict";

        // UI ìš”ì†Œ ì°¸ì¡°
        const topicInput = document.getElementById('topicInput');
        const fileInput = document.getElementById('fileInput');
        const fileNameDisplay = document.getElementById('fileNameDisplay');
        const infographicType = document.getElementById('infographicType');
        const colorPalette = document.getElementById('colorPalette');
        const aspectRatio = document.getElementById('aspectRatio');
        const generateButton = document.getElementById('generateButton');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const buttonText = document.getElementById('buttonText');
        const imageA = document.getElementById('imageA');
        const messageA = document.getElementById('messageA');
        const downloadButton = document.getElementById('downloadButton');
        const promptButton = document.getElementById('promptButton');
        const structuredDataArea = document.getElementById('structuredDataArea');
        const copyButton = document.getElementById('copyButton');
        const dropZone = document.getElementById('dropZone');
        const promptModal = document.getElementById('promptModal');
        const promptDisplayArea = document.getElementById('promptDisplayArea');

        // ì „ì—­ ìƒíƒœ ë³€ìˆ˜
        let currentInfographicBase64 = null;
        let currentImagePrompt = null;

        const MAX_FILES = 5;
        const MAX_FILE_SIZE_MB = 4;
        
        // --- UI ë° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ---
        
        // 2. ì²¨ë¶€ íŒŒì¼ ëª©ë¡ í‘œì‹œ í•¨ìˆ˜
        const updateFileNameDisplay = (files) => {
            const display = fileNameDisplay;
            display.innerHTML = ''; // ì´ì „ ë‚´ìš© ì´ˆê¸°í™”

            if (!files || files.length === 0) {
                display.textContent = 'ì²¨ë¶€ëœ íŒŒì¼ ì—†ìŒ';
                display.className = 'text-sm text-gray-500 text-center mt-3 w-full max-h-24 overflow-y-auto'; // ê¸°ë³¸ ìŠ¤íƒ€ì¼
            } else {
                display.className = 'text-sm font-semibold text-indigo-700 text-left mt-3 w-full max-h-24 overflow-y-auto p-2 bg-gray-50 rounded-md'; // íŒŒì¼ ì²¨ë¶€ ì‹œ ìŠ¤íƒ€ì¼

                // íŒŒì¼ ê°œìˆ˜ í‘œì‹œ
                const countHeader = document.createElement('p');
                countHeader.className = 'font-bold mb-1';
                countHeader.textContent = `ì²¨ë¶€ëœ íŒŒì¼: ${files.length}ê°œ`;
                display.appendChild(countHeader);

                // íŒŒì¼ ëª©ë¡ (ul)
                const ul = document.createElement('ul');
                ul.className = 'list-disc list-inside'; // ë‹¨ìˆœí•œ ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼

                Array.from(files).forEach(file => {
                    const li = document.createElement('li');
                    li.className = 'text-sm font-normal text-gray-700 truncate'; // ê¸´ íŒŒì¼ëª…ì€ ì˜ë¼ë‚´ê¸°
                    li.textContent = `${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`;
                    li.title = file.name; // ë§ˆìš°ìŠ¤ ì˜¤ë²„ ì‹œ ì „ì²´ ì´ë¦„ í‘œì‹œ
                    ul.appendChild(li);
                });
                display.appendChild(ul);
            }
        };

        fileInput.addEventListener('change', (event) => {
            updateFileNameDisplay(event.target.files);
        });

        window.resetForm = function() {
            topicInput.value = '';
            fileInput.value = '';
            infographicType.value = 'PolicyRecommendation';
            colorPalette.value = 'Policy Blue/Gray';
            aspectRatio.value = '16:9';
            updateFileNameDisplay([]);
            
            imageA.classList.add('hidden');
            imageA.src = '';
            messageA.classList.remove('hidden');
            messageA.textContent = 'ì£¼ì œë¥¼ ì…ë ¥í•˜ê³  ìƒì„± ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.';
            downloadButton.style.display = 'none';
            promptButton.style.display = 'none';
            structuredDataArea.value = '';
            
            currentInfographicBase64 = null;
            currentImagePrompt = null;
            
            generateButton.disabled = false;
            loadingSpinner.classList.add('hidden');
            buttonText.textContent = 'ì¸í¬ê·¸ë˜í”½ ì‹œì•ˆ ìƒì„± ì‹œì‘';
            
            console.log('í¼ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
        };
        
        window.showPromptModal = function() {
            if (currentImagePrompt) {
                promptDisplayArea.value = currentImagePrompt;
                promptModal.style.display = 'flex';
            } else {
                alert("ìƒì„±ëœ í”„ë¡¬í”„íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ì¸í¬ê·¸ë˜í”½ì„ ìƒì„±í•´ì£¼ì„¸ìš”.");
            }
        };

        window.closePromptModal = function() {
            promptModal.style.display = 'none';
        };

        copyButton.addEventListener('click', () => {
            structuredDataArea.select();
            structuredDataArea.setSelectionRange(0, 99999);
            
            if (document.execCommand('copy')) {
                alert("êµ¬ì¡°í™”ëœ í…ìŠ¤íŠ¸ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
            } else {
                alert("ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. Ctrl+C (Cmd-C)ë¥¼ ì‚¬ìš©í•´ì£¼ì„¸ìš”.");
            }
        });
        
        // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ë¡œì§
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => { dropZone.addEventListener(eventName, preventDefaults, false); document.body.addEventListener(eventName, preventDefaults, false); });
        function preventDefaults (e) { e.preventDefault(); e.stopPropagation(); }
        ['dragenter', 'dragover'].forEach(eventName => { dropZone.addEventListener(eventName, () => dropZone.classList.add('drag-over'), false); });
        ['dragleave', 'drop'].forEach(eventName => { dropZone.addEventListener(eventName, () => dropZone.classList.remove('drag-over'), false); });
        dropZone.addEventListener('drop', handleDrop, false);
        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            if (files.length > MAX_FILES) { alert(`íŒŒì¼ì€ ìµœëŒ€ ${MAX_FILES}ê°œê¹Œì§€ë§Œ ì²¨ë¶€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`); return; }
            let validFiles = true;
            for (const file of files) { if (file.size > MAX_FILE_SIZE_MB * 1024 * 1024) { alert(`íŒŒì¼ "${file.name}"ì˜ í¬ê¸°ê°€ ${MAX_FILE_SIZE_MB}MBë¥¼ ì´ˆê³¼í•©ë‹ˆë‹¤. ëª¨ë“  íŒŒì¼ì„ ë‹¤ì‹œ í™•ì¸í•´ ì£¼ì„¸ìš”.`); validFiles = false; break; } }
            if (validFiles) { fileInput.files = files; updateFileNameDisplay(files); }
        }


        // --- API í˜¸ì¶œ ìœ í‹¸ë¦¬í‹° ---

        function fileToGenerativePart(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const base64Data = reader.result.split(',')[1]; 
                    resolve({ inlineData: { data: base64Data, mimeType: file.type } });
                };
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }

        async function fetchWithRetry(url, options, maxRetries = 5) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.status === 429 && i < maxRetries - 1) {
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        console.warn(`Rate limit exceeded. Retrying in ${delay / 1000}s...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    }
                    if (response.status === 401) {
                        throw new Error(`API ì¸ì¦ ì˜¤ë¥˜ (401). Canvas í™˜ê²½ì—ì„œ API í‚¤ê°€ ì œëŒ€ë¡œ ë¡œë“œë˜ì§€ ì•Šì•˜ê±°ë‚˜ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.`);
                    }
                    if (!response.ok) {
                        throw new Error(`API ì‘ë‹µ ì˜¤ë¥˜: ${response.statusText} (${response.status})`);
                    }
                    return response;
                } catch (error) {
                    if (i === maxRetries - 1) {
                        throw error;
                    }
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    console.warn(`Fetch error. Retrying in ${delay / 1000}s...`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        // --- 1ë‹¨ê³„: í”„ë¡¬í”„íŠ¸ì™€ êµ¬ì¡°í™”ëœ ë°ì´í„° ìƒì„± (í•œêµ­ì–´ ë°ì´í„° ì¶”ì¶œ ë° ìœ„ì¹˜ ë¼ë²¨ ì¶”ê°€) ---
        async function generatePromptAndData(topicText, infographicType, selectedPalette, files) {
            
            // SYSTEM PROMPT: í…ìŠ¤íŠ¸ ë‹¨ìˆœí™” ë° ëª…í™•í•œ ìœ„ì¹˜ ë¼ë²¨ ìš”êµ¬
            const systemPrompt = "ë‹¹ì‹ ì€ ì •ì±… ë³´ê³ ì„œì— í•„ìš”í•œ ì •ë³´ë¥¼ ë¶„ì„í•˜ê³  êµ¬ì¡°í™”í•˜ëŠ” ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì‚¬ìš©ì ì…ë ¥ê³¼ ì²¨ë¶€ íŒŒì¼ì„ ë¶„ì„í•˜ì—¬ 1) ì‹œê°ì  ë””ìì¸ í…œí”Œë¦¿ì„ ìœ„í•œ ì˜ì–´ ì´ë¯¸ì§€ í”„ë¡¬í”„íŠ¸(ìµœì†Œí•œì˜ í…ìŠ¤íŠ¸ í¬í•¨)ì™€ 2) ì¸í¬ê·¸ë˜í”½ì— ì‚½ì…í•  **ì •í™•í•˜ê³  ê¹¨ë—í•œ í•œêµ­ì–´ í…ìŠ¤íŠ¸ ì •ë³´**ë¥¼ ì¶”ì¶œí•´ì•¼ í•©ë‹ˆë‹¤. íŠ¹íˆ, í…ìŠ¤íŠ¸ì˜ ë‚´ìš©ì„ **PPT ìŠ¬ë¼ì´ë“œì— ë°”ë¡œ ë³µì‚¬/ë¶™ì—¬ë„£ê¸° í•  ìˆ˜ ìˆëŠ” ìˆ˜ì¤€ì˜ í•µì‹¬ ìš”ì•½ê³¼ ë‹¨ë¬¸ ìœ„ì£¼**ë¡œ ì‘ì„±í•´ì•¼ í•©ë‹ˆë‹¤. ë˜í•œ, ê° ì„¹ì…˜ì„ **'=== [ìœ„ì¹˜: ìƒë‹¨ ì œëª©] ==='**ê³¼ ê°™ì€ ëª…í™•í•œ êµ¬ë¶„ì„ ê³¼ ë¼ë²¨ë¡œ ì‹œì‘í•˜ê³ , ë‚´ìš© ë¶€ë¶„ì€ **'# ì œëª©'**ê³¼ **'* í•µì‹¬ ë‚´ìš©'**ì˜ Markdown í˜•ì‹ìœ¼ë¡œ ë¶„ë¦¬í•˜ì—¬ ì‚¬ìš©ìê°€ PPTì—ì„œ ì‰½ê²Œ í™œìš©í•  ìˆ˜ ìˆë„ë¡ êµ¬ì„±í•´ì•¼ í•©ë‹ˆë‹¤. ìµœì¢… ì¶œë ¥ì€ í•˜ë‚˜ì˜ JSON ê°ì²´ì—¬ì•¼ í•©ë‹ˆë‹¤.";
            
            const userQuery = `ë‹¤ìŒ ì£¼ì œì™€ ë°ì´í„°(ì²¨ë¶€ íŒŒì¼ ì°¸ì¡°)ë¥¼ ë°”íƒ•ìœ¼ë¡œ ë‘ ê°€ì§€ ê²°ê³¼ë¥¼ ìƒì„±í•˜ì„¸ìš”:
1. **Image Prompt:** **'${infographicType}'** í…œí”Œë¦¿ì˜ ì‹œê°ì  ì„¤ëª…ì„ ìœ„í•œ ì˜ì–´ í”„ë¡¬í”„íŠ¸. **'${selectedPalette}'** íŒ”ë ˆíŠ¸ë¥¼ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤. ì´ë¯¸ì§€ì—ëŠ” **ABSOLUTELY NO TEXTUAL LABELS OR WORDS.** Only focus on visual structure, data charts, and clear icons. **Numerical data within charts/graphs should be visually present but not as legible text labels.**
2. **Structured Data (í•œêµ­ì–´):** ì¸í¬ê·¸ë˜í”½ì— ì‚½ì…í•  **ì™„ì „í•˜ê³  ì •í™•í•œ í•œêµ­ì–´ í…ìŠ¤íŠ¸ ë‚´ìš©**ì„ Markdown í˜•ì‹ìœ¼ë¡œ ì •ë¦¬í•©ë‹ˆë‹¤. **ê° ì„¹ì…˜ ì•ì— '=== [ìœ„ì¹˜: ìƒë‹¨ ì œëª©] ==='ê³¼ ê°™ì´ ëª…í™•í•œ êµ¬ë¶„ì„ ì„ í¬í•¨í•œ ìœ„ì¹˜ ë¼ë²¨ì„ ì¶”ê°€**í•˜ê³ , ë‚´ìš©ì€ **ë‹¨ë¬¸ê³¼ í•µì‹¬ ìš”ì•½ ìœ„ì£¼ë¡œ êµ¬ì„±**í•˜ì—¬ ë³µì¡ë„ë¥¼ ìµœì†Œí™”í•´ì•¼ í•©ë‹ˆë‹¤.

í•µì‹¬ ì£¼ì œ: ${topicText}`;

            const responseSchema = {
                type: "OBJECT",
                properties: {
                    "imagePrompt": { "type": "STRING", "description": "The detailed Imagen visual prompt for the template, focusing on layout and color, using placeholder text." },
                    "structuredData": { "type": "STRING", "description": "The complete, legible Korean text content for the infographic, formatted using Markdown, including placement labels." }
                },
                required: ["imagePrompt", "structuredData"]
            };


            // API í˜¸ì¶œ ì¤€ë¹„
            let contents = [];
            if (files && files.length > 0) {
                const fileParts = await Promise.all(Array.from(files).map(fileToGenerativePart));
                contents.push({ role: "user", parts: [...fileParts, { text: userQuery }] });
            } else {
                contents.push({ role: "user", parts: [{ text: userQuery }] });
            }

            const payload = {
                contents: contents,
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: responseSchema
                }
            };

            const url = `${GEMINI_API_URL}?key=${apiKey}`;
            const response = await fetchWithRetry(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const result = await response.json();
            const jsonText = result?.candidates?.[0]?.content?.parts?.[0]?.text;
            if (!jsonText) {
                console.error("Gemini JSON response error:", result);
                throw new Error("Gemini ì‘ë‹µì—ì„œ ìœ íš¨í•œ JSONì„ ì°¾ì„ ìˆ˜ ì—†ê±°ë‚˜ ë°ì´í„° êµ¬ì¡°ê°€ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤. (ì½˜ì†” ë¡œê·¸ í™•ì¸)");
            }
            try {
                return JSON.parse(jsonText);
            } catch (e) {
                console.error("JSON íŒŒì‹± ì˜¤ë¥˜:", e);
                console.error("ìˆ˜ì‹ ëœ í…ìŠ¤íŠ¸:", jsonText);
                throw new Error("Geminiê°€ ìœ íš¨í•˜ì§€ ì•Šì€ JSONì„ ë°˜í™˜í–ˆìŠµë‹ˆë‹¤. í…œí”Œë¦¿ í”„ë¡¬í”„íŠ¸ë‚˜ ë°ì´í„°ê°€ ë„ˆë¬´ ê¸¸ê±°ë‚˜ ë³µì¡í–ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. (ì½˜ì†” ë¡œê·¸ í™•ì¸)");
            }
        }
        
        // --- 2ë‹¨ê³„: ì´ë¯¸ì§€ ìƒì„± í•¨ìˆ˜ (PNG ëª¨ë“œ ì „ìš©) ---
        async function generateImage(imagePrompt, selectedPalette, selectedRatio) {
            // í…œí”Œë¦¿ í”„ë¡¬í”„íŠ¸: 2. ê¸€ìëŠ” ì—†ì• ê³  ìˆ«ìëŠ” ê¹¨ì§€ì§€ ì•Šê²Œ í¬í•¨
            const finalPrompt = `A professional infographic design TEMPLATE, clean lines, modern flat design, using the **${selectedPalette}** color palette. ABSOLUTELY NO TEXTUAL LABELS OR WORDS. Only focus on visual structure, data charts, and clear icons. Numerical data within charts/graphs should be visually present but not as legible text labels. Based on the concept: "${imagePrompt}"`;
            
            const payload = { 
                instances: { prompt: finalPrompt }, 
                parameters: { 
                    "sampleCount": 1, 
                    "aspectRatio": selectedRatio
                } 
            };
            
            const url = `${IMAGEN_API_URL}?key=${apiKey}`;
            const response = await fetchWithRetry(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const result = await response.json();
            const base64Data = result?.predictions?.[0]?.bytesBase64Encoded;
            
            if (!base64Data) {
                console.error("Imagen response structure error:", result);
                throw new Error("Imagen ì‘ë‹µì—ì„œ ì´ë¯¸ì§€ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            }
            return `data:image/png;base64,${base64Data}`;
        }

        // --- ë©”ì¸ ìƒì„± í•¨ìˆ˜ ---
        window.generateInfographics = async function() {
            const topicText = topicInput.value.trim();
            const files = fileInput.files;
            const type = infographicType.value;
            const selectedPalette = colorPalette.value;
            const selectedRatio = aspectRatio.value;
            const selectedTypeText = infographicType.options[infographicType.selectedIndex].text.split('(')[0].trim();

            if (topicText.length < 10 && files.length === 0) {
                alert("ì¸í¬ê·¸ë˜í”½ì„ ìƒì„±í•˜ë ¤ë©´ ì£¼ì œë¥¼ 10ì ì´ìƒ ì…ë ¥í•˜ê±°ë‚˜ íŒŒì¼ì„ ì²¨ë¶€í•´ì•¼ í•©ë‹ˆë‹¤.");
                return;
            }
            
            if (files.length > MAX_FILES) { alert(`íŒŒì¼ì€ ìµœëŒ€ ${MAX_FILES}ê°œê¹Œì§€ë§Œ ì²¨ë¶€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`); return; }
            for (const file of files) { if (file.size > MAX_FILE_SIZE_MB * 1024 * 1024) { alert(`íŒŒì¼ "${file.name}"ì˜ í¬ê¸°ê°€ ${MAX_FILE_SIZE_MB}MBë¥¼ ì´ˆê³¼í•©ë‹ˆë‹¤. ëª¨ë“  íŒŒì¼ì„ ë‹¤ì‹œ í™•ì¸í•´ ì£¼ì„¸ìš”.`); return; } }

            // UI ì´ˆê¸°í™” ë° ë¡œë”© ì‹œì‘
            generateButton.disabled = true;
            loadingSpinner.classList.remove('hidden');
            promptButton.style.display = 'none'; 
            currentImagePrompt = null;
            downloadButton.style.display = 'none';
            imageA.classList.add('hidden');
            messageA.classList.remove('hidden');
            structuredDataArea.value = '';

            messageA.textContent = `1ë‹¨ê³„: AIê°€ íŒŒì¼ ${files.length}ê°œì™€ í…ìŠ¤íŠ¸ë¥¼ ë¶„ì„í•˜ì—¬ êµ¬ì¡°í™” ë° ë””ìì¸ í”„ë¡¬í”„íŠ¸ë¥¼ ìƒì„± ì¤‘ì…ë‹ˆë‹¤.`;
            buttonText.textContent = `1ë‹¨ê³„: ${selectedTypeText}í˜• ë¶„ì„ ë° êµ¬ì¡° ì¶”ì¶œ ì¤‘...`;

            try {
                // 1. í”„ë¡¬í”„íŠ¸ ë° êµ¬ì¡°í™”ëœ í•œêµ­ì–´ ë°ì´í„° ìƒì„± (Gemini)
                const { imagePrompt, structuredData } = await generatePromptAndData(topicText, type, selectedPalette, files);
                currentImagePrompt = imagePrompt;
                
                // êµ¬ì¡°í™”ëœ í…ìŠ¤íŠ¸ë¥¼ ì²˜ë¦¬í•˜ì—¬ ê°œì¡°ì‹ í˜•íƒœë¡œ í‘œì‹œ
                // ******************************************************
                // ì¤‘ìš” ìˆ˜ì •: í…ìŠ¤íŠ¸ ê°œì¡°ì‹ ê°€ë…ì„±ì„ ìœ„í•´ ë¶ˆí•„ìš”í•œ ê³µë°± ì œê±° í›„ í• ë‹¹
                const processedStructuredData = structuredData.trim().replace(/^\s*\n/gm, '\n').replace(/\n\s*#/g, '\n#').replace(/\n\s*\*/g, '\n*');
                structuredDataArea.value = processedStructuredData; 
                // ******************************************************

                
                buttonText.textContent = '2ë‹¨ê³„: ë””ìì¸ í…œí”Œë¦¿ ì´ë¯¸ì§€ ìƒì„± ì¤‘... (ì•½ 30ì´ˆ ì†Œìš”)';
                messageA.textContent = 'ì´ë¯¸ì§€ ìƒì„± ì¤‘...';
                
                // 2. ì´ë¯¸ì§€ ìƒì„± (Imagen)
                const imageUrl = await generateImage(imagePrompt, selectedPalette, selectedRatio);
                currentInfographicBase64 = imageUrl;
                
                // UI ì—…ë°ì´íŠ¸: ì„±ê³µ
                imageA.src = imageUrl;
                imageA.alt = `${selectedTypeText}í˜• ë””ìì¸ í…œí”Œë¦¿: ${topicInput.value}`;
                imageA.classList.remove('hidden');
                messageA.classList.add('hidden');
                
                downloadButton.style.display = 'block'; 
                promptButton.style.display = 'flex'; 

                buttonText.textContent = `${selectedTypeText}í˜• í…œí”Œë¦¿ ë° í•œêµ­ì–´ í…ìŠ¤íŠ¸ ìƒì„± ì™„ë£Œ!`;
                alert("ìƒì„± ì™„ë£Œ! ìš°ì¸¡ 'êµ¬ì¡°í™”ëœ í•œêµ­ì–´ í…ìŠ¤íŠ¸'ë¥¼ ë³µì‚¬í•˜ì—¬ ì´ë¯¸ì§€ í…œí”Œë¦¿ì— ë¶™ì—¬ë„£ì–´ PPTë¥¼ ì™„ì„±í•˜ì„¸ìš”.");

            } catch (error) {
                console.error("ì¸í¬ê·¸ë˜í”½ ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
                
                let errorMessage = `ì˜¤ë¥˜ ë°œìƒ: ${error.message}. (ì½˜ì†” í™•ì¸)`;
                
                if (error.message.includes('API ì¸ì¦ ì˜¤ë¥˜ (401)')) {
                    errorMessage = "API ì¸ì¦ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤ (401 ì˜¤ë¥˜). Canvas í™˜ê²½ì— API í‚¤ê°€ ì œëŒ€ë¡œ ë¡œë“œë˜ì§€ ì•Šì•˜ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.";
                }

                messageA.textContent = errorMessage;
                messageA.classList.remove('hidden');
                imageA.classList.add('hidden');
                
                downloadButton.style.display = 'none';
                promptButton.style.display = 'none';
                
                buttonText.textContent = 'ì˜¤ë¥˜ ë°œìƒ. ë‹¤ì‹œ ì‹œë„';

            } finally {
                generateButton.disabled = false;
                loadingSpinner.classList.add('hidden');
                setTimeout(() => {
                    if (buttonText.textContent.includes('ì™„ë£Œ') || buttonText.textContent.includes('ì˜¤ë¥˜')) {
                         buttonText.textContent = 'ì¸í¬ê·¸ë˜í”½ ì‹œì•ˆ ìƒì„± ì‹œì‘';
                    }
                }, 5000);
            }
        }

        // --- ë‹¤ìš´ë¡œë“œ ë¡œì§ ---
        downloadButton.addEventListener('click', () => {
            if (currentInfographicBase64) {
                const fileNamePrefix = infographicType.value.toLowerCase().replace(/\s/g, '_');
                const timestamp = new Date().toISOString().slice(0,10);
                
                // PNG ë‹¤ìš´ë¡œë“œ
                const link = document.createElement('a');
                link.href = currentInfographicBase64;
                link.download = `infographic_template_${fileNamePrefix}_${timestamp}.png`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } else {
                alert("ë‹¤ìš´ë¡œë“œí•  ê²°ê³¼ë¬¼ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ìƒì„± ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.");
            }
        });
    </script>
</body>
</html>
